var ELUS=ELUS||{version:1,statusBarMessage:"",rule:{},ruleHint:"",gameType:"Classic",level:0,round:0,errorsLeft:0,lastFigure:"",nextFigureTemplate:"",animating:!1};ELUS.Size={S:"Small",B:"Big"},ELUS.Color={G:"Blue",Y:"Yellow"},ELUS.Shape={C:"Circle",L:"Lozenge"},ELUS.Figure=function(e){this.shorthand=e,this.size=e.substr(0,1),this.color=e.substr(1,1),this.shape=e.substr(2,1),this.oppositeSize=function(){return"B"==this.size?"S":"B"},this.oppositeColor=function(){return"G"==this.color?"Y":"G"},this.oppositeShape=function(){return"C"==this.shape?"L":"C"},this.equals=function(e){return this.shorthand===e.shorthand},this.render=function(e,t){return"<span "+(e?'id="'+e+'" ':"")+'class="figure'+(t?" "+t:"")+'" data-value="'+this.shorthand+'" data-label="'+this.toString()+'"><span class="figure-icon fa figure-icon'+("B"==this.size?" big":" small")+("Y"==this.color?" yellow":" blue")+("C"==this.shape?" fa-circle-o":" fa-lozenge-o")+'"></span><span class="figure-label">'+this.toString()+"</span></span>"},this.toString=function(){return ELUS.Size[this.size]+" "+ELUS.Color[this.color]+" "+ELUS.Shape[this.shape]}},ELUS.Rule=function(e){function t(e){var t=e.substr(0,1),s=e.substr(1,1);return"s"==t?("="==s?"same":"!"==s?"different":ELUS.Size[s])+" size":"c"==t?("="==s?"same":"!"==s?"different":ELUS.Color[s])+" color":"h"==t?("="==s?"same":"!"==s?"different":ELUS.Shape[s])+" shape":void 0}this.shorthand=e;var s=this.shorthand.indexOf("?"),a=this.shorthand.indexOf(":");this.condition=this.shorthand.substring(0,s),this.trueTemplate=-1==a?this.shorthand.substring(s+1):this.shorthand.substring(s+1,a),this.falseTemplate=-1==a?"":this.shorthand.substring(a+1),this.toString=function(){var e=this.condition.substr(0,1),s=this.condition.substr(1,1);if("-"==this.condition)return"Always choose figure with {0}".format(t(this.trueTemplate));var a="s"==e?ELUS.Size[s]:"c"==e?ELUS.Color[s]:ELUS.Shape[s];return"If the last figure is {0}, then choose figure with {1}, otherwise choose figure with {2}".format(a,t(this.trueTemplate),t(this.falseTemplate))}},ELUS.ClassicRules=[["-?c=","-?s=","-?h=","-?c!","-?s!","-?h!"],["cY?sB:sS","hC?cG:cY","hC?sS:sB","sB?hC:hL","sB?cY:cG"],["hL?cG:s=","cY?hC:hL","cG?hC:hL","cG?sB:h!","cG?sB:hC","hC?cY:sS","sB?hL:cG","sB?hC:c=","sB?cY:hL","sB?cG:cY","sB?cG:h=","sB?cG:c!"]],ELUS.getRandomElement=function(e){return e[Math.floor(Math.random()*e.length)]},ELUS.getNRandomElements=function(e,t){for(var s=[],a=0;t>a;a++)s.push(e.splice(ELUS.indexOf(e,ELUS.getRandomElement(e)),1)[0]);return s},ELUS.generateRule=function(e,t){var s;if("Random"==e){if(Math.random()<=.25)s="-?"+ELUS.getRandomRuleTemplate();else{s=ELUS.getRandomRuleTemplate()+"?";for(var a=ELUS.getRandomRuleTemplate(),n=a;n==a;)n=ELUS.getRandomRuleTemplate();s+=a+":"+n}}else s=ELUS.getRandomElement(ELUS.ClassicRules[t-1]);return new ELUS.Rule(s)},ELUS.generateAllFigures=function(){for(var e=[],t=0;t<Object.keys(ELUS.Size).length;t++)for(var s=0;s<Object.keys(ELUS.Color).length;s++)for(var a=0;a<Object.keys(ELUS.Shape).length;a++)e.push(new ELUS.Figure(Object.keys(ELUS.Size)[t]+Object.keys(ELUS.Color)[s]+Object.keys(ELUS.Shape)[a]));return e},ELUS.getNextFigureTemplate=function(e,t){var s,a,n,r=e.condition.substr(0,1),i=e.condition.substr(1,1);return"s"==r?s=i:"c"==r?a=i:"h"==r&&(n=i),"-"==e.condition||s==t.size||a==t.color||n==t.shape?e.trueTemplate:e.falseTemplate},ELUS.getMatchingFigures=function(e,t,s){var a,n,r,i=[],o=s.substr(0,1),u=s.substr(1,1);"s"==o?a="="==u?t.size:"!"==u?t.oppositeSize():u:"c"==o?n="="==u?t.color:"!"==u?t.oppositeColor():u:"h"==o&&(r="="==u?t.shape:"!"==u?t.oppositeShape():u);for(var l=0;l<e.length;l++){var c=e[l];a&&a!=c.size||n&&n!=c.color||r&&r!=c.shape||i.push(c)}return i},ELUS.getNonMatchingFigures=function(e,t,s){var a=ELUS.getMatchingFigures(e,t,s);return e.filter(function(e){return ELUS.indexOf(a,e)<0})},ELUS.getNextChoicesShuffled=function(e,t,s){return[ELUS.getRandomElement(ELUS.getMatchingFigures(e,t,s))].concat(ELUS.getNRandomElements(ELUS.getNonMatchingFigures(e,t,s),2)).sort(function(){return.5-Math.random()})},ELUS.indexOf=function(e,t){var s=t instanceof ELUS.Figure;if(!s)return e.indexOf(t);for(var a=0;a<e.length;a++)if(e[a].equals(t))return a;return-1},ELUS.isCorrectFigure=function(e,t,s,a){return ELUS.indexOf(ELUS.getMatchingFigures(e,s,a),t)>=0},String.prototype.format=function(){var e=this;for(var t in arguments)e=e.replace("{"+t+"}",arguments[t]);return e},ELUS.getRandomRuleTemplate=function(){var e=parseInt(3*Math.random()),t=parseInt(2*Math.random());switch(e){case 0:return"s"+Object.keys(ELUS.Size)[t];case 1:return"c"+Object.keys(ELUS.Color)[t];case 2:return"h"+Object.keys(ELUS.Shape)[t]}},ELUS.addFigureRow=function(e){var t=$('<div class="figure-row"><span class="figure-row-number">'+e+"</span></div>");if($(".figures").append(t),1==e){var s=$('<span class="stats"><span class="stats-label">Level</span><span class="stats-value" id="level-value" data-toggle="tooltip">'+ELUS.level+"</span></span>");t.append(s)}else if(2==e){var s=$('<span class="stats"><span class="stats-label">Round</span><span class="stats-value" id="round-value">1/8</span></span>');t.append(s)}else if(3==e){var s=$('<span class="stats"><span class="stats-label">Errors</span><span class="stats-value" id="tries-left-value">3</span></span>');t.append(s)}$("#round-value").text(e+"/8"),t.hide().slideDown(500,function(){3==e&&(ELUS.animating=!1,$("#button-cancel-game").removeAttr("disabled"))})},ELUS.addFigure=function(e){$(".figure-row").last().children(".figure-row-number").after(e.render(null,"not-selected"))},ELUS.addChoices=function(){var e=$('<span id="next-placeholder" class="figure next-placeholder" data-original-title="'+ELUS.ruleHint+'" data-html="true"><span class="figure-label next">?</span></span>').tooltip({placement:"bottom"});$(".figure-row").last().children(".figure-row-number").after(e);for(var t=ELUS.getNextChoicesShuffled(ELUS.allFigures,ELUS.lastFigure,ELUS.nextFigureTemplate),s=0;3>s;s++){var a=t[s],n=$(a.render("choice"+s,"selectable"));n.click(function(){ELUS.selectFigure(this,t)}),$(".figure-row").last().children().last().after(n)}$(".figure.selectable").hover(function(){$(this).hasClass("selectable")&&ELUS.changeStatusbarText("Select <b>"+this.getAttribute("data-label")+"</b> as the next figure.")},function(){$(this).hasClass("selectable")&&ELUS.resetStatusbarText()})},ELUS.selectFigure=function(e,t){var s=new ELUS.Figure(e.getAttribute("data-value")),a=e.getAttribute("id"),n=ELUS.isCorrectFigure(t,s,ELUS.lastFigure,ELUS.nextFigureTemplate);$("[id^=choice]").each(function(){$(this).removeClass("selectable").addClass($(this).attr("id")==a?n?"correct":"incorrect":"not-selected").off("click").off("hover").hover(function(){console.log("h")})});var r=$("#next-placeholder");r.animate({opacity:0},200,function(){var e=parseInt(a.substr(-1)),t=r.outerWidth()+4,s=$("#choice0").outerWidth()+4,n=[];n.push((0==e?0:s)-t),n.push((0==e?0:1==e?-1*s:s)-t),n.push((2!=e?0:-2*s)-t),$("[id^=choice]").each(function(e){$(this).removeAttr("id").animate({left:n[e]},500)}),r.removeAttr("id")}),setTimeout(function(){n?ELUS.changeStatusbarText('<span class="green">Correct choice!</span>',!0):(ELUS.errorsLeft--,$("#tries-left-value").fadeOut(200,function(){$(this).text(ELUS.errorsLeft).fadeIn()}),ELUS.changeStatusbarText('<span class="red">Incorrect choice!</span> '+ELUS.errorsLeft+" tries left.",!0)),9==++ELUS.round||0==ELUS.errorsLeft?ELUS.finishLevel(ELUS.errorsLeft>0):(ELUS.lastFigure=s,ELUS.nextFigureTemplate=ELUS.getNextFigureTemplate(ELUS.rule,ELUS.lastFigure),ELUS.addFigureRow(ELUS.round),ELUS.addChoices())},700)},ELUS.addInitialFigures=function(){ELUS.animating=!0,$("#button-cancel-game").prop("disabled",!0);for(var e=[],t=0;3>t;t++)ELUS.lastFigure=ELUS.getRandomElement(0==t?ELUS.allFigures:ELUS.getMatchingFigures(ELUS.allFigures,ELUS.lastFigure,ELUS.nextFigureTemplate)),ELUS.nextFigureTemplate=ELUS.getNextFigureTemplate(ELUS.rule,ELUS.lastFigure),e.push(ELUS.lastFigure);$.each(e,function(e,t){setTimeout(function(){ELUS.addFigureRow(++ELUS.round),ELUS.addFigure(t)},500*e)})},ELUS.newGame=function(){$(".figures").show(),$("#button-new-game-grp").hide(),$("#button-next-level").hide(),ELUS.level=0,ELUS.nextLevel()},ELUS.initializeGame=function(){$(".figures").hide(),$("#button-new-game-grp").show(),$("#button-instructions").show(),$("#button-cancel-game").hide(),$("#button-finish-game").hide(),$("#button-next-level").hide(),ELUS.changeStatusbarText("Welcome to ELUS!",!0,!0)},ELUS.finishLevel=function(e){var t=e?'<span class="green">You won!</span>':'<span class="red">You lost.</span>';t+=" The rule was: <b>"+ELUS.rule.toString()+"</b>.",e&&ELUS.isGameWon()?(t+='<br><span class="teal">Congratulations, you have won the game!</span>',$("#button-finish-game").show()):e?$("#button-next-level").show():($("#button-cancel-game").hide(),$("#button-new-game-grp").show(),$("#button-finish-game").show()),ELUS.changeStatusbarText(t,!0)},ELUS.isGameWon=function(){return 9==ELUS.round&&"Classic"==ELUS.gameType&&3==ELUS.level||"Random"==ELUS.gameType},ELUS.cancelGame=function(e){if(!ELUS.animating){var e=$(e),t=e.attr("pressed");t?ELUS.initializeGame():(e.attr("pressed",!0),e.text("Are you sure?"),e.on("mouseout",function(){e.removeAttr("pressed"),e.text("Cancel game")}))}},ELUS.nextLevel=function(){switch(ELUS.level++,ELUS.round=0,ELUS.errorsLeft=3,ELUS.rule=ELUS.generateRule(ELUS.gameType,ELUS.level),ELUS.ruleHint="<span class='level'>Level "+ELUS.level+"</span> - ",ELUS.level){case 1:ELUS.ruleHint+="Always choose figure with <span class='selector'>same</span> <span class='attribute'>ATTRIBUTE X</span> <br>or with <span class='selector'>different</span> <span class='attribute'>ATTRIBUTE X</span><br>as the last figure";break;case 2:ELUS.ruleHint="If the last figure has <span class='attribute'>ATTRIBUTE X</span> ,<br>then choose figure with <span class='selector'>this</span> of <span class='attribute'>ATTRIBUTE Y</span> ,<br>otherwise choose figure with<span class='selector'>that</span> of <span class='attribute'>ATTRIBUTE Y</span>";break;case 3:ELUS.ruleHint="If the last figure has <span class='attribute'>ATTRIBUTE X</span> ,<br>then choose figure with <span class='selector'>this</span> of <span class='attribute'>ATTRIBUTE Y</span> ,<br>otherwise: choose figure with <span class='selector'>that</span> of <span class='attribute'>ATTRIBUTE Z</span><br>or with <span class='selector'>same</span> <span class='attribute'>ATTRIBUTE Z</span> <br>or with <span class='selector'>different</span> <span class='attribute'>ATTRIBUTE Z</span><br>as the last figure"}$(".figures").empty(),$(".result").empty(),$("#instructions").hide(),$("#instructions-carousel").carousel(0),$("#button-next-level").hide(),$("#button-cancel-game").show(),$("#tries-left-value").text(ELUS.errorsLeft),$("#level-value").text(ELUS.level),$("#level-value").attr("title","foo"),ELUS.changeStatusbarText("Starting "+("Random"==ELUS.gameType?"random level.":"level "+ELUS.level),!0,!0),ELUS.addInitialFigures(),setTimeout(function(){ELUS.addFigureRow(++ELUS.round),ELUS.addChoices()},1500)},ELUS.changeGameType=function(e){ELUS.gameType=e,$("#button-new-game").text("New game: "+e)},ELUS.changeStatusbarText=function(e,t,s){t&&(ELUS.statusBarMessage=e);var a=s?0:100;$(".statusbar-message").fadeOut(a,function(){$(this).html(e).hide().fadeIn(a)})},ELUS.resetStatusbarText=function(){ELUS.changeStatusbarText(ELUS.statusBarMessage)},ELUS.initialize=function(){ELUS.changeGameType("Classic"),$("#button-new-game").click(function(){ELUS.newGame()}).hover(function(){ELUS.changeStatusbarText("Start new game.")},ELUS.resetStatusbarText),$("#button-new-game-grp .dropdown-toggle").hover(function(){ELUS.changeStatusbarText("Change game type.")},ELUS.resetStatusbarText),$("#button-new-game-grp .dropdown-menu li").click(function(e){ELUS.changeGameType($(e.target).text())}).hover(function(e){var t="";switch($(e.target).text()){case"Classic":t="<b>Classic game</b> - Play 3 consecutive rounds of rules with increasing difficulty.";break;case"Random":t="<b>Random game</b> - Play a round with a randomized rule."}ELUS.changeStatusbarText(t)},ELUS.resetStatusbarText),$("#button-next-level").hide().click(function(){ELUS.nextLevel()}).hover(function(){ELUS.changeStatusbarText("Go to the next level.")},ELUS.resetStatusbarText),$("#button-cancel-game, #button-finish-game").click(function(e){ELUS.cancelGame(e.target)}).hover(function(){ELUS.changeStatusbarText("End current game and return to the main menu.")},ELUS.resetStatusbarText),$("#button-instructions").click(function(){$("#instructions").slideToggle(200,function(){$("#instructions-carousel").carousel(0)})}).hover(function(){ELUS.changeStatusbarText("View instructions for playing ELUS.")},ELUS.resetStatusbarText),$("#button-about").hover(function(){ELUS.changeStatusbarText("Find out about the author of ELUS.")},ELUS.resetStatusbarText),$("#button-github").hover(function(){ELUS.changeStatusbarText("Check out the source code on GitHub (opens in a new tab).")},ELUS.resetStatusbarText),$("#instructions").on("hidden.bs.modal",function(){$("#instructions-carousel").carousel(0)}),$("#instructions-carousel").on("slid.bs.carousel",function(){var e=$("#instructions-carousel .item.active");if(e.is(":first-child")?$("#instructions-carousel .left").hide():$("#instructions-carousel .left").show(),e.is(":last-child")){var t=$('<span class="fa fa-close" data-dismiss="modal"></span>');$("#instructions-carousel .right").html(t).removeAttr("data-slide").click(function(){$("#instructions-carousel").carousel(0)})}else{var t=$('<span class="fa fa-arrow-right"></span>');$("#instructions-carousel .right").html(t).attr("data-slide","next").off("click")}}),$(".version").text("v"+ELUS.version.toFixed(3)),ELUS.initializeGame()};
